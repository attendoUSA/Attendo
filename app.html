<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendo | Attendance System</title>
    <link rel="stylesheet" href="style.css">
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Moderator Panel Styles */
        .moderator-header {
            background: linear-gradient(135deg, #f59e0b 0%, #ff865a 100%);
            padding: 2rem;
            border-radius: 12px;
            color: white;
            margin-bottom: 2rem;
        }

        .moderator-header h2 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
        }

        .moderator-header .small {
            color: rgba(255,255,255,0.9);
            margin: 0;
        }

        .stats-grid-mod {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg, #1a1a1a);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color, #333);
        }

        [data-theme="light"] .stat-card {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin: 0 0 0.5rem 0;
            color: #f59e0b;
            font-weight: 700;
        }

        .stat-card p {
            margin: 0;
            color: var(--text-secondary, #999);
            font-size: 0.9rem;
        }

        .danger-zone {
            background: rgba(220, 38, 38, 0.1);
            border: 2px solid rgba(220, 38, 38, 0.3);
            border-radius: 8px;
            padding: 2rem;
        }

        .danger-zone h3 {
            color: #dc2626;
            margin-top: 0;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
            margin-right: 0.5rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, #f59e0b 0%, #ff8b61 100%);
            color: white;
        }

        .btn-sm:hover {
            background: linear-gradient(135deg, #fbbf24 0%, #ff9b5c 100%);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            background: linear-gradient(135deg, #f59e0b 0%, #ff8b61 100%);
            color: white;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }

        /* Better table spacing for moderator panel */
        #moderatorDash .table {
            width: 100%;
            table-layout: auto;
        }

        #moderatorDash .table th,
        #moderatorDash .table td {
            padding: 1rem;
            white-space: nowrap;
        }

        /* Code styling for join codes */
        code {
            background: rgba(245, 158, 11, 0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #f59e0b;
            font-weight: 600;
        }

        [data-theme="light"] code {
            background: rgba(245, 158, 11, 0.15);
        }

        /* Dashboard tabs spacing */
        .tabs.mb-3 {
            margin-bottom: 2rem;
        }

        /* Dashboard tabs wrapper */
        .dashboard-tabs-wrapper {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 32px 0 32px;
        }

        /* Make moderator dashboard wider */
        #moderatorDash {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Override app-container width for better moderator display */
        #moderatorDash .table-container {
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="header-brand">
                <img src="logo.png" class="header-logo" alt="Attendo logo"/>
                <div class="logo">Attendo</div>
            </div>
            <button class="menu-toggle" id="menuToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul id="navMenu">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="pricing.html">Pricing</a></li>
                <li><a href="app.html" class="active">Login</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="social.html">Social</a></li>
            </ul>
            <span class="user-tag hidden" id="authTag">Welcome</span>
            <button class="logout-btn hidden" id="btnLogout">Logout</button>
            <button class="theme-toggle" id="themeToggle" title="Toggle theme">
                <span class="theme-icon">üåô</span>
            </button>
        </nav>
    </header>

    <main>
        <div class="app-container">
            <!-- Landing / Login Screen -->
            <section class="card" id="landing">
                <h2 class="center">Sign in or create an account</h2>
                <div class="tabs center">
                    <button class="tab active" id="tabSignIn">Sign In</button>
                    <button class="tab" id="tabCreate">Create Account</button>
                </div>

                <!-- Sign In Form -->
                <div class="grid grid-2" id="signInForm">
                    <div>
                        <label>Email</label>
                        <input class="input" id="loginEmail" type="email" placeholder="you@school.edu" />
                    </div>
                    <div>
                        <label>Password</label>
                        <input type="password" class="input" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                    </div>
                    <div>
                        <button class="btn-primary" id="btnLogin">Sign In</button>
                    </div>
                </div>

                <!-- Create Account Form -->
                <div id="createFlow" class="hidden">
                    <p class="center small">Choose an account type:</p>
                    <div class="tabs center">
                        <button class="tab active" id="tabRoleAdmin">Admin</button>
                        <button class="tab" id="tabRoleStudent">Student</button>
                    </div>

                    <div class="grid grid-2" id="createForm">
                        <div>
                            <label>Full Name</label>
                            <input class="input" id="regName" placeholder="Full name" />
                        </div>
                        <div>
                            <label>Email</label>
                            <input class="input" id="regEmail" type="email" placeholder="you@school.edu" />
                        </div>
                        <div>
                            <label>Password</label>
                            <input type="password" class="input" id="regPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                        </div>

                        <!-- Student only -->
<div id="studentExtra" class="hidden">
    <label>Student ID (8 digits)</label>
    <input 
        type="text" 
        id="studentIdInput" 
        class="input" 
        placeholder="12345678" 
        maxlength="8"
        pattern="[0-9]{8}"
    />
    <p class="small">‚ö†Ô∏è You can only edit this once after registration if incorrect</p>
    
    <label>Upload Face Photo</label>
    <input type="file" id="faceFile" accept="image/*" class="input" />
    <img id="facePreview" class="preview hidden" alt="Face preview" />
</div>

                        <!-- Admin only -->
                        <div id="adminExtra">
                            <p class="small">Admins don't need a face photo. You will create courses and join codes.</p>
                        </div>

                        <div>
                            <button class="btn-primary" id="btnCreate">Create Account</button>
                            <p class="small" id="createMsg"></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Admin Dashboard -->
            <!-- Dashboard Tabs Container (shown when logged in as professor) -->
            <div class="dashboard-tabs-wrapper hidden" id="dashboardTabsWrapper">
                <div class="tabs center mb-3" id="dashboardTabs">
                    <button class="tab active" id="tabAdminView">Admin Dashboard</button>
                    <button class="tab hidden" id="tabModeratorView">üõ°Ô∏è Super Admin</button>
                </div>
            </div>

            <section class="card hidden" id="adminDash">
                <h2>Admin Dashboard</h2>
                <div class="grid grid-2">
                    <div>
                        <h3>Create Course</h3>
                        <label>Course Name</label>
                        <input class="input" id="courseName" placeholder="Course name (e.g., Intro to AI)" />
                        <label>Late After (minutes)</label>
                        <input class="input" id="lateMinutes" type="number" value="5" />
                        <label>Absent After (minutes)</label>
                        <input class="input" id="absentMinutes" type="number" value="15" />
                        <button class="btn-primary mt-2" id="btnCreateCourse">Create Course & Join Code</button>
                        <p class="small" id="courseCreateMsg"></p>

                        <div class="mt-3">
                            <h3>Live Attendance Console</h3>
                            <p class="small" id="sessionInfo">Select a course and click "Start Check-In" to begin attendance.</p>
                            <select class="input" id="consoleSelectCourse">
                                <option value="">Select a course...</option>
                            </select>
                            <button class="btn-primary mt-2" id="btnStartCheckIn">Start Check-In</button>

                            <div class="mt-3">
                                <h3>Live Attendance</h3>
                                <div class="search-box">
                                    <input class="input" id="liveAttSearch" placeholder="Search students..." />
                                </div>
                                <table class="table">
                                    <thead><tr><th>Student Name</th><th>Student ID</th><th>Time (ET)</th><th>Status</th></tr></thead>
                                    <tbody id="attRows"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div>
    <h3>My Courses</h3>
    <div class="search-box">
        <input class="input" id="courseSearch" placeholder="Search courses..." />
    </div>
    <table class="table">
        <thead><tr><th>Name</th><th>Course ID</th><th>Join Code</th><th>Students</th><th>Actions</th></tr></thead>
        <tbody id="courseRows"></tbody>
    </table>

                        <!-- Course Roster Section -->
                        <div class="mt-3">
                            <h3 class="section-toggle" id="rosterToggle">Course Rosters</h3>
                            <div id="rosterSection" class="section-collapsed">
                                <select class="input" id="rosterSelectCourse">
                                    <option value="">Select a course to view roster...</option>
                                </select>
                                <table class="table mt-2">
                                    <thead><tr><th>Student Name</th><th>Student ID</th><th>Email</th></tr></thead>
                                    <tbody id="rosterRows"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Delete ALL Students Section -->
                        <div class="mt-3">
                            <h3>Delete All Student Data</h3>
                            <p class="small">‚ö†Ô∏è This will delete face embeddings and course registrations for ALL students in the system.</p>
                            <button class="btn-danger mt-2" id="btnDeleteAllStudents">Delete All Student Data</button>
                        </div>
                    </div>
                </div>

                <!-- Attendance History -->
                <div class="mt-3">
                    <div class="section-header">
                        <h3>Attendance History</h3>
                        <button class="btn-secondary" id="btnExportCSV">Export to CSV</button>
                    </div>
                    <div class="grid grid-2">
                        <div class="search-box">
                            <input class="input" id="historySearch" placeholder="Search by student name..." />
                        </div>
                        <div class="search-box">
                            <select class="input" id="historyCourseFilter">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Course</th>
                                <th>Student Name</th>
                                <th>Student ID</th>
                                <th>Time (ET)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyRows"></tbody>
                    </table>
                </div>
            </section>

            <!-- Student Dashboard -->
            <section class="card hidden" id="studentDash">
                <h2>Student Dashboard</h2>

                <!-- Student Info Card -->
                <div class="student-info-card">
    <h3>Student Information</h3>
    <div class="info-row">
        <span class="info-label">Name:</span>
        <span class="info-value" id="studentNameDisplay">Loading...</span>
    </div>
    <div class="info-row">
        <span class="info-label">Student ID:</span>
        <span class="info-value">
            <span class="kbd" id="studentIdDisplay">Loading...</span>
            <button class="btn-edit-id hidden" id="btnEditStudentId" title="Edit Student ID">‚úèÔ∏è</button>
        </span>
    </div>
    <div class="info-row">
        <span class="info-label">Email:</span>
        <span class="info-value" id="studentEmailDisplay">Loading...</span>
    </div>
    <div id="editIdMessage" class="small hidden" style="margin-top: 12px;"></div>
</div>

                <div class="grid grid-2">
                    <div>
                        <h3>Enroll with Join Code</h3>
                        <input class="input" id="joinCode" placeholder="e.g., 4KJ9TQ" />
                        <button class="btn-primary mt-2" id="btnEnroll">Enroll</button>
                        <p class="small" id="enrollMsg"></p>

                        <div class="mt-3">
                            <h3>My Courses</h3>
                            <div class="search-box">
                                <input class="input" id="studentCourseSearch" placeholder="Search courses..." />
                            </div>
                            <table class="table">
                                <thead><tr><th>Course Name</th><th>Course ID</th></tr></thead>
                                <tbody id="studentCourseRows"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <h3>Attendance Status</h3>
                        <p class="small">Your attendance will be recorded when your professor starts a check-in session. Make sure to have your Student ID ready when checking in during class.</p>

                        <div class="attendance-summary mt-3">
                            <h4>Recent Attendance</h4>
                            <div id="recentAttendanceDisplay">
                                <p class="small">No recent attendance records</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Attendance History -->
                <div class="mt-3">
                    <div class="section-header">
                        <h3>My Attendance History</h3>
                        <button class="btn-secondary" id="btnExportStudentCSV">Export to CSV</button>
                    </div>
                    <div class="search-box">
                        <select class="input" id="studentHistoryCourseFilter">
                            <option value="">All Courses</option>
                        </select>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Course</th>
                                <th>Time (ET)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="studentHistoryRows"></tbody>
                    </table>
                </div>
            </section>

            <!-- Moderator Dashboard -->
            <section class="card hidden" id="moderatorDash">
                <div class="moderator-header">
                    <h2>üõ°Ô∏è Super Admin / Moderator Panel</h2>
                    <p class="small">God mode: Full system access</p>
                </div>

                <!-- System Stats -->
                <div class="stats-grid-mod">
                    <div class="stat-card">
                        <h3 id="statTotalUsers">0</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statStudents">0</h3>
                        <p>Students</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statProfessors">0</h3>
                        <p>Professors</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statCourses">0</h3>
                        <p>Courses</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statSessions">0</h3>
                        <p>Sessions</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="statAttendance">0</h3>
                        <p>Check-ins</p>
                    </div>
                </div>

                <!-- All Users -->
                <div class="mt-3">
                    <h3>All Users</h3>
                    <div class="search-box">
                        <input class="input" id="modUserSearch" placeholder="Search users..." />
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Student ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modUserRows"></tbody>
                        </table>
                    </div>
                </div>

                <!-- All Courses -->
                <div class="mt-3">
                    <h3>All Courses</h3>
                    <div class="search-box">
                        <input class="input" id="modCourseSearch" placeholder="Search courses..." />
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Course Name</th>
                                    <th>Join Code</th>
                                    <th>Professor</th>
                                    <th>Students</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="modCourseRows"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Recent Attendance -->
                <div class="mt-3">
                    <h3>Recent Attendance (Last 100)</h3>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Course</th>
                                    <th>Professor</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="modAttendanceRows"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="mt-3 danger-zone">
                    <h3>‚ö†Ô∏è Danger Zone</h3>
                    <button class="btn-danger" id="btnCleanup">Clean Up Test Data</button>
                    <p class="small">This will delete all attendance records and sessions</p>
                </div>
            </section>
        </div>
    </main>

    <!-- Check-In Console Modal (for Professors) -->
    <!-- Check-In Console Modal (for Professors) -->
    <div id="checkinModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Automatic Check-In Console</h2>
                <button class="modal-close" id="btnCloseModal">√ó</button>
            </div>
            <div class="modal-body">
                <h3 id="modalCourseName">Course Name</h3>
                <p class="small">ü§ñ Automatic face detection is active. Students will be checked in as they appear on camera.</p>

                <div class="checkin-form">
                    <div class="video-container">
                        <video id="modalVideo" autoplay muted playsinline></video>
                        <div id="videoOverlay" class="video-overlay hidden">
                            <div class="spinner"></div>
                            <p>Processing...</p>
                        </div>
                    </div>

                    <p class="checkin-status" id="modalCheckStatus"></p>
                    
                    <!-- Manual Override Section (Collapsible) -->
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: var(--text-secondary);">Manual Check-In (Backup)</summary>
                        <div style="margin-top: 1rem;">
                            <label>Student ID</label>
                            <input class="input" id="modalStudentId" placeholder="Enter 8-digit ID" maxlength="8" />
                            <button class="btn-secondary mt-2" id="btnModalCheckIn">Manual Check In</button>
                        </div>
                    </details>
                </div>

                <div class="session-stats mt-3">
                    <h4>Session Statistics</h4>
                    <div class="stats-grid">
                        <div class="stat">
                            <span class="stat-label">Present</span>
                            <span class="stat-value" id="statPresent">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Late</span>
                            <span class="stat-value" id="statLate">0</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Total</span>
                            <span class="stat-value" id="statTotal">0</span>
                        </div>
                    </div>
                </div>

                <div class="recent-checkins mt-3">
                    <h4>Recent Check-Ins</h4>
                    <div id="recentCheckinsDisplay">
                        <p class="small">Waiting for faces...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-danger" id="btnStopSession">Stop Session & Close</button>
            </div>
        </div>
    </div>
<!-- Edit Student ID Modal -->
<div id="editStudentIdModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Edit Student ID</h2>
            <button class="modal-close" id="btnCloseEditModal">√ó</button>
        </div>
        <div class="modal-body">
            <p class="small" style="color: var(--warning-bg); margin-bottom: 16px;">
                ‚ö†Ô∏è Warning: You can only edit your Student ID once. Make sure it's correct!
            </p>
            <label>New Student ID (8 digits)</label>
            <input 
                type="text" 
                id="newStudentIdInput" 
                class="input" 
                placeholder="12345678"
                maxlength="8"
                pattern="[0-9]{8}"
            />
            <p class="small" id="editIdError"></p>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" id="btnCancelEdit">Cancel</button>
            <button class="btn-primary" id="btnConfirmEdit">Update Student ID</button>
        </div>
    </div>
</div>
    <!-- Confirmation Dialog -->
    <div id="confirmDialog" class="confirmation-dialog hidden">
        <div class="confirmation-content">
            <h3 id="confirmTitle">Confirm Action</h3>
            <p id="confirmMessage">Are you sure you want to proceed?</p>
            <div class="confirmation-actions">
                <button class="btn-secondary" id="confirmCancel">Cancel</button>
                <button class="btn-danger" id="confirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Attendo. All rights reserved.</p>
    </footer>

    <script>
/* =========================
   GLOBALS
   ========================= */
const API = 'https://attendo-ojjl.onrender.com';
let role = null, username = null, studentId = null, activeSessionId = null, activeCourseId = null;
let adminCourses = [], studentCourses = [], allAttendance = [], studentAttendance = [];
let modalVideoStream = null;

/* =========================
   HELPERS
   ========================= */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function show(sel, visible = true) {
    const el = $(sel);
    if (el) el.classList.toggle('hidden', !visible);
}

function toEasternDateOnly(isoStr) {
    const d = new Date(isoStr);
    return d.toLocaleDateString('en-US', { timeZone: 'America/New_York' });
}

function toEasternTimeOnly(isoStr) {
    const d = new Date(isoStr);
    return d.toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit' });
}

/* =========================
   CUSTOM NOTIFICATIONS
   ========================= */
function showNotification(title, message, type = 'info') {
    // Remove any existing notifications
    const existing = $('.notification');
    if (existing) existing.remove();

    // Create notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    
    const icons = {
        success: '‚úì',
        error: '‚úï',
        warning: '‚ö†',
        info: '‚Ñπ'
    };
    
    notification.innerHTML = `
        <div class="notification-icon">${icons[type]}</div>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close">√ó</button>
    `;
    
    document.body.appendChild(notification);
    
    // Close button
    notification.querySelector('.notification-close').addEventListener('click', () => {
        notification.remove();
    });
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100px)';
            setTimeout(() => notification.remove(), 300);
        }
    }, 5000);
}

/* =========================
   CONFIRMATION DIALOG
   ========================= */
function showConfirmDialog(title, message) {
    return new Promise((resolve) => {
        const dialog = $('#confirmDialog');
        $('#confirmTitle').textContent = title;
        $('#confirmMessage').textContent = message;
        show('#confirmDialog', true);
        
        const handleOk = () => {
            show('#confirmDialog', false);
            cleanup();
            resolve(true);
        };
        
        const handleCancel = () => {
            show('#confirmDialog', false);
            cleanup();
            resolve(false);
        };
        
        const cleanup = () => {
            $('#confirmOk').removeEventListener('click', handleOk);
            $('#confirmCancel').removeEventListener('click', handleCancel);
        };
        
        $('#confirmOk').addEventListener('click', handleOk);
        $('#confirmCancel').addEventListener('click', handleCancel);
    });
}

/* =========================
   API WRAPPER
   ========================= */
async function api(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json' };
    const token = localStorage.getItem('token');
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const opts = { method, headers };
    if (body && method !== 'GET') opts.body = JSON.stringify(body);

    const resp = await fetch(API + endpoint, opts);
    if (!resp.ok) {
        const err = await resp.json();
        throw new Error(err.detail || 'Request failed');
    }
    return resp.json();
}

/* =========================
   FACE API SETUP
   ========================= */
/* =========================
   FACE-API.JS
   ========================= */
const MODEL_URL = './weights';
let _faceModelsReady = false;

async function loadFaceModels(){
  if (_faceModelsReady) return;
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
  _faceModelsReady = true;
}
function faceOptions(){ return new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }); }
async function ensureModels(){ if(!_faceModelsReady) await loadFaceModels(); }

async function embeddingFromImageElement(imgEl){
  await ensureModels();
  const det = await faceapi.detectSingleFace(imgEl, faceOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!det) throw new Error('No face detected in the uploaded photo.');
  return Array.from(det.descriptor);
}

async function setupCamera(videoEl){
  const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' } });
  videoEl.srcObject = stream;
  await new Promise(res => videoEl.onloadedmetadata = res);
  return stream;
}
async function embeddingFromVideoElement(videoEl){
  await ensureModels();
  const det = await faceapi.detectSingleFace(videoEl, faceOptions()).withFaceLandmarks().withFaceDescriptor();
  if(!det) throw new Error('No face detected on camera.');
  return Array.from(det.descriptor);
}


/* =========================
   THEME
   ========================= */
function initTheme() {
    const saved = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', saved);
    const icon = $('#themeToggle .theme-icon');
    if (icon) icon.textContent = saved === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

$('#themeToggle').onclick = () => {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
    $('#themeToggle .theme-icon').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
};

/* =========================
   HAMBURGER MENU
   ========================= */
const menuToggle = $('#menuToggle');
const navMenu = $('#navMenu');

if (menuToggle && navMenu) {
    menuToggle.onclick = () => {
        menuToggle.classList.toggle('active');
        navMenu.classList.toggle('active');
    };
    
    document.addEventListener('click', (e) => {
        if (!menuToggle.contains(e.target) && !navMenu.contains(e.target)) {
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
        }
    });
    
    navMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            menuToggle.classList.remove('active');
            navMenu.classList.remove('active');
        });
    });
}

/* =========================
   AUTH
   ========================= */
$('#tabSignIn').onclick = () => {
    show('#signInForm', true);
    show('#createFlow', false);
    $('#tabSignIn').classList.add('active');
    $('#tabCreate').classList.remove('active');
};

$('#tabCreate').onclick = () => {
    show('#signInForm', false);
    show('#createFlow', true);
    $('#tabSignIn').classList.remove('active');
    $('#tabCreate').classList.add('active');
};

$('#tabRoleAdmin').onclick = () => {
    $('#tabRoleAdmin').classList.add('active');
    $('#tabRoleStudent').classList.remove('active');
    show('#adminExtra', true);
    show('#studentExtra', false);
};

$('#tabRoleStudent').onclick = () => {
    $('#tabRoleStudent').classList.add('active');
    $('#tabRoleAdmin').classList.remove('active');
    show('#adminExtra', false);
    show('#studentExtra', true);
};

$('#faceFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        const img = $('#facePreview');
        img.src = ev.target.result;
        show('#facePreview', true);
    };
    reader.readAsDataURL(file);
};

$('#btnCreate').onclick = async () => {
    const name = $('#regName').value.trim();
    const email = $('#regEmail').value.trim();
    const password = $('#regPassword').value.trim();
    const isAdmin = $('#tabRoleAdmin').classList.contains('active');
    const r = isAdmin ? 'professor' : 'student';

    if (!name || !email || !password) {
        $('#createMsg').textContent = 'All fields required';
        return;
    }

    const payload = { name, email, password, role: r };

    // Handle student-specific fields
    if (r === 'student') {
        // Get and validate student ID
        const studentIdInput = $('#studentIdInput').value.trim();
        if (!studentIdInput) {
            $('#createMsg').textContent = 'Student ID is required';
            return;
        }
        if (!/^\d{8}$/.test(studentIdInput)) {
            $('#createMsg').textContent = 'Student ID must be exactly 8 digits';
            return;
        }
        payload.student_id = studentIdInput;

        // Get face embedding
        const img = $('#facePreview');
        if (!img.src || img.src === window.location.href) {
            $('#createMsg').textContent = 'Face photo required for students';
            return;
        }
        try {
            const vec = await embeddingFromImageElement(img);
            payload.face_embedding = vec;
        } catch (e) {
            $('#createMsg').textContent = 'No face detected in photo';
            return;
        }
    }

    try {
        const data = await api('/auth/register', 'POST', payload);
        localStorage.setItem('token', data.access_token);
        role = data.role;
        username = data.name;
        studentId = data.student_id;
        $('#authTag').textContent = `Welcome, ${username}`;
        show('#authTag', true);
        show('#btnLogout', true);
        show('#landing', false);
        if (role === 'professor') loadAdmin();
        else loadStudent();
        showNotification('Success', 'Account created successfully!', 'success');
    } catch (e) {
        $('#createMsg').textContent = e.message || 'Registration failed';
        showNotification('Error', e.message || 'Registration failed', 'error');
    }
};

$('#btnLogin').onclick = async () => {
    try {
        const data = await api('/auth/login', 'POST', {
            email: $('#loginEmail').value.trim(),
            password: $('#loginPassword').value.trim()
        });
        localStorage.setItem('token', data.access_token);
        role = data.role;
        username = data.name;
        studentId = data.student_id;
        $('#authTag').textContent = `Welcome, ${username}`;
        show('#authTag', true);
        show('#btnLogout', true);
        show('#landing', false);
        if (role === 'professor') loadAdmin();
        else loadStudent();
        showNotification('Success', 'Logged in successfully!', 'success');
    } catch (e) {
        showNotification('Error', e.message || 'Login failed', 'error');
    }
};

$('#btnLogout').onclick = () => {
    localStorage.removeItem('token');
    show('#authTag', false);
    show('#btnLogout', false);
    show('#adminDash', false);
    show('#studentDash', false);
    show('#moderatorDash', false);
    show('#dashboardTabsWrapper', false);
    show('#landing', true);
    role = null;
    username = null;
    studentId = null;
    
    // Reset tabs
    if (typeof isSuperAdmin !== 'undefined') {
        isSuperAdmin = false;
    }
    const tabModeratorView = document.getElementById('tabModeratorView');
    const tabAdminView = document.getElementById('tabAdminView');
    if (tabModeratorView) {
        show('#tabModeratorView', false);
        tabModeratorView.classList.remove('active');
    }
    if (tabAdminView) {
        tabAdminView.classList.add('active');
    }
};

/* =========================
   ADMIN
   ========================= */
async function loadAdmin() {
    show('#adminDash', true);
    await refreshAdminCourses();
    refreshAttendanceHistory();
    checkSuperAdminAccess(); // Check if user has super admin access
}

async function refreshAdminCourses() {
    try {
        const courses = await api('/courses/my-taught', 'GET');
        adminCourses = courses;
        updateHistoryCourseFilter(courses);
        updateCourseSelects(courses);
        renderAdminCourses(courses);
    } catch (e) {
        $('#courseRows').innerHTML = `<tr><td colspan="4" class="small">${e.message || 'Failed to load courses'}</td></tr>`;
    }
}

function updateCourseSelects(courses) {
    const consoleSelect = $('#consoleSelectCourse');
    consoleSelect.innerHTML = '<option value="">Select a course...</option>';

    const rosterSelect = $('#rosterSelectCourse');
    rosterSelect.innerHTML = '<option value="">Select a course to view roster...</option>';

    for (const c of courses) {
        const opt1 = document.createElement('option');
        opt1.value = c.id;
        opt1.textContent = c.name;
        consoleSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = c.id;
        opt2.textContent = c.name;
        rosterSelect.appendChild(opt2);
    }
}

function renderAdminCourses(courses) {
    const tbody = $('#courseRows');
    tbody.innerHTML = '';
    if (!courses.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="small">No courses yet. Create one above.</td></tr>`;
        return;
    }
    for (const c of courses) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${c.name}</td>
            <td><span class="kbd">${c.id}</span></td>
            <td><span class="kbd">${c.code}</span></td>
            <td>${c.student_count || 0}</td>
            <td>
                <button class="btn-danger btn-sm" onclick="deleteCourse(${c.id}, '${c.name.replace(/'/g, "\\'")}')">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    }
}
$('#courseSearch').oninput = (e) => {
    const query = e.target.value.toLowerCase();
    const filtered = adminCourses.filter(c => c.name.toLowerCase().includes(query));
    renderAdminCourses(filtered);
};

$('#btnCreateCourse').onclick = async () => {
    const name = $('#courseName').value.trim();
    if (!name) {
        $('#courseCreateMsg').textContent = 'Enter course name';
        return;
    }

    try {
        const data = await api('/courses/create', 'POST', { name });
        $('#courseCreateMsg').textContent = `Created! Join code: ${data.code}`;
        $('#courseName').value = '';
        await refreshAdminCourses();
        showNotification('Success', `Course created! Join code: ${data.code}`, 'success');
    } catch (e) {
        $('#courseCreateMsg').textContent = e.message || 'Failed';
        showNotification('Error', e.message || 'Failed to create course', 'error');
    }
};

// Course roster
$('#rosterSelectCourse').onchange = async () => {
    const courseId = $('#rosterSelectCourse').value;
    if (!courseId) {
        $('#rosterRows').innerHTML = '';
        return;
    }

    try {
        const roster = await api(`/courses/${courseId}/roster`, 'GET');
        const tbody = $('#rosterRows');
        tbody.innerHTML = '';
        if (!roster.length) {
            tbody.innerHTML = `<tr><td colspan="3" class="small">No students enrolled yet.</td></tr>`;
            return;
        }
        for (const s of roster) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${s.name}</td><td><span class="kbd">${s.student_id}</span></td><td>${s.email}</td>`;
            tbody.appendChild(tr);
        }
    } catch (e) {
        $('#rosterRows').innerHTML = `<tr><td colspan="3" class="small">${e.message}</td></tr>`;
    }
};

/* =========================
   SESSION MANAGEMENT
   ========================= */
$('#btnStartCheckIn').onclick = async () => {
    const courseId = $('#consoleSelectCourse').value;
    if (!courseId) {
        showNotification('Error', 'Select a course first', 'error');
        return;
    }

    try {
        const lateMin = parseInt($('#lateMinutes').value) || 5;
        const absentMin = parseInt($('#absentMinutes').value) || 15;
        const session = await api('/sessions/start', 'POST', {
            course_id: parseInt(courseId),
            late_after_minutes: lateMin,
            absent_after_minutes: absentMin
        });

        activeSessionId = session.session_id;
        activeCourseId = parseInt(courseId);

        const courseName = adminCourses.find(c => c.id == courseId)?.name || 'Course';
        $('#modalCourseName').textContent = courseName;

        show('#checkinModal', true);
        show('#videoOverlay', false);

        await setupCamera($('#modalVideo'));
        modalVideoStream = $('#modalVideo').srcObject;

        startLiveAttendancePolling();
        startAutoCheckIn(); // Start automatic face detection
        showNotification('Session Started', 'Automatic face detection enabled', 'success');
    } catch (e) {
        showNotification('Error', e.message || 'Failed to start session', 'error');
    }
};

$('#btnCloseModal').onclick = () => {
    stopAutoCheckIn();
    stopModalCamera();
    show('#checkinModal', false);
};

$('#btnStopSession').onclick = async () => {
    if (!activeSessionId) return;

    // Add confirmation dialog
    const confirmed = await showConfirmDialog(
        'Stop Attendance Session?',
        'Are you sure you want to stop this attendance session? Students will no longer be able to check in.'
    );
    
    if (!confirmed) return;

    try {
        await api(`/sessions/stop/${activeSessionId}`, 'POST');
        stopAutoCheckIn();
        stopModalCamera();
        show('#checkinModal', false);
        activeSessionId = null;
        activeCourseId = null;
        stopLiveAttendancePolling();
        await refreshAttendanceHistory();
        showNotification('Session Ended', 'Attendance session has been closed', 'info');
    } catch (e) {
        showNotification('Error', e.message || 'Failed to stop session', 'error');
    }
};

function stopModalCamera() {
    if (modalVideoStream) {
        modalVideoStream.getTracks().forEach(track => track.stop());
        modalVideoStream = null;
    }
    recentlyCheckedIn.clear();
}

// Automatic face detection and check-in
let autoCheckInInterval = null;
let recentlyCheckedIn = new Set(); // Track recently checked students

async function startAutoCheckIn() {
    if (autoCheckInInterval) return; // Already running
    
    autoCheckInInterval = setInterval(async () => {
        try {
            const videoEl = $('#modalVideo');
            if (!videoEl || !videoEl.srcObject) return;
            
            // Get face embedding from video
            const embedding = await embeddingFromVideoElement(videoEl);
            
            // Get all enrolled students for this course
            const roster = await api(`/courses/${activeCourseId}/roster`, 'GET');
            
            // Try to match face with enrolled students
            let bestMatch = null;
            let bestSimilarity = 0;
            
            for (const student of roster) {
                // Skip if already checked in this session
                if (recentlyCheckedIn.has(student.student_id)) continue;
                
                try {
                    // Try checking in with this student's ID
                    const result = await api('/checkin/with-id', 'POST', {
                        course_id: activeCourseId,
                        student_id: student.student_id,
                        face_embedding: embedding
                    });
                    
                    // If successful, this is our match
                    bestMatch = result;
                    recentlyCheckedIn.add(student.student_id);
                    break;
                } catch (e) {
                    // Face didn't match this student, continue
                    continue;
                }
            }
            
            if (bestMatch) {
                $('#modalCheckStatus').textContent = `‚úì ${bestMatch.student_name} - ${bestMatch.status.toUpperCase()}`;
                $('#modalCheckStatus').className = 'checkin-status success';
                
                addRecentCheckin(bestMatch.student_name, bestMatch.status);
                updateSessionStats();
                refreshLiveAttendance();
                showNotification('Auto Check-In', `${bestMatch.student_name} marked ${bestMatch.status}`, 'success');
                
                // Remove from recently checked after 10 seconds to prevent duplicates
                setTimeout(() => {
                    recentlyCheckedIn.delete(bestMatch.student_id);
                }, 10000);
            }
        } catch (e) {
            // Silently continue - likely no face detected
            console.log('Auto check-in scan:', e.message);
        }
    }, 2000); // Check every 2 seconds
}

function stopAutoCheckIn() {
    if (autoCheckInInterval) {
        clearInterval(autoCheckInInterval);
        autoCheckInInterval = null;
    }
    recentlyCheckedIn.clear();
}

// Manual check-in button (kept as backup option)
$('#btnModalCheckIn').onclick = async () => {
    const studentIdInput = $('#modalStudentId').value.trim();
    if (!studentIdInput) {
        showNotification('Error', 'Enter student ID', 'error');
        return;
    }

    show('#videoOverlay', true);
    $('#modalCheckStatus').textContent = '';

    try {
        const embedding = await embeddingFromVideoElement($('#modalVideo'));

        const result = await api('/checkin/with-id', 'POST', {
            course_id: activeCourseId,
            student_id: studentIdInput,
            face_embedding: embedding
        });

        $('#modalCheckStatus').textContent = `‚úì ${result.student_name} - ${result.status.toUpperCase()}`;
        $('#modalCheckStatus').className = 'checkin-status success';
        $('#modalStudentId').value = '';

        addRecentCheckin(result.student_name, result.status);
        updateSessionStats();
        refreshLiveAttendance();
        showNotification('Check-In Successful', `${result.student_name} marked ${result.status}`, 'success');
    } catch (e) {
        $('#modalCheckStatus').textContent = `‚úï ${e.message}`;
        $('#modalCheckStatus').className = 'checkin-status error';
        showNotification('Check-In Failed', e.message, 'error');
    } finally {
        show('#videoOverlay', false);
    }
};

function addRecentCheckin(name, status) {
    const display = $('#recentCheckinsDisplay');
    const entry = document.createElement('div');
    entry.className = 'checkin-entry';
    const time = new Date().toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit' });
    entry.textContent = `${name} - ${status.toUpperCase()} at ${time}`;
    display.insertBefore(entry, display.firstChild);

    // Keep only last 5
    while (display.children.length > 5) {
        display.removeChild(display.lastChild);
    }
}

async function updateSessionStats() {
    if (!activeCourseId) return;
    try {
        const attendance = await api(`/attendance/live/${activeCourseId}`, 'GET');
        const present = attendance.filter(a => a.status === 'present').length;
        const late = attendance.filter(a => a.status === 'late').length;
        $('#statPresent').textContent = present;
        $('#statLate').textContent = late;
        $('#statTotal').textContent = attendance.length;
    } catch (e) {
        console.error('Failed to update stats:', e);
    }
}

let liveAttendanceInterval = null;

function startLiveAttendancePolling() {
    refreshLiveAttendance();
    liveAttendanceInterval = setInterval(refreshLiveAttendance, 3000);
}

function stopLiveAttendancePolling() {
    if (liveAttendanceInterval) {
        clearInterval(liveAttendanceInterval);
        liveAttendanceInterval = null;
    }
}

async function refreshLiveAttendance() {
    if (!activeCourseId) return;
    try {
        const attendance = await api(`/attendance/live/${activeCourseId}`, 'GET');
        renderLiveAttendance(attendance);
        updateSessionStats();
    } catch (e) {
        console.error('Failed to refresh live attendance:', e);
    }
}

function renderLiveAttendance(data) {
    const tbody = $('#attRows');
    tbody.innerHTML = '';
    if (!data.length) return;

    for (const a of data) {
        const time = toEasternTimeOnly(a.timestamp);
        const statusClass = a.status === 'present' ? 'status-present' : (a.status === 'late' ? 'status-late' : 'status-absent');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${a.student_name}</td><td><span class="kbd">${a.student_id}</span></td><td>${time}</td><td><span class="status ${statusClass}">${a.status}</span></td>`;
        tbody.appendChild(tr);
    }
}

$('#liveAttSearch').oninput = async () => {
    if (!activeCourseId) return;
    const query = $('#liveAttSearch').value.toLowerCase();
    const attendance = await api(`/attendance/live/${activeCourseId}`, 'GET');
    const filtered = attendance.filter(a => a.student_name.toLowerCase().includes(query));
    renderLiveAttendance(filtered);
};

// Delete ALL students
$('#btnDeleteAllStudents').onclick = async () => {
    const confirmed = await showConfirmDialog(
        'Delete All Student Data?',
        '‚ö†Ô∏è WARNING: This will permanently delete face embeddings and course registrations for ALL students in the entire system. This action cannot be undone. Are you absolutely sure?'
    );
    
    if (!confirmed) return;

    try {
        const result = await api('/students/all/data', 'DELETE');
        showNotification('Success', `${result.message}. Deleted: ${result.deleted_count} students`, 'success');
        await refreshAdminCourses();
        await refreshAttendanceHistory();
    } catch (e) {
        showNotification('Error', e.message || 'Deletion failed', 'error');
    }
};

/* =========================
   ATTENDANCE HISTORY
   ========================= */
async function refreshAttendanceHistory() {
    try {
        const data = await api('/attendance/history', 'GET');
        allAttendance = data;
        renderAttendanceHistory(data);
    } catch (e) {
        $('#historyRows').innerHTML = `<tr><td colspan="6" class="small">${e.message || 'Failed to load history'}</td></tr>`;
    }
}

function renderAttendanceHistory(data) {
    const tbody = $('#historyRows');
    tbody.innerHTML = '';
    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="small">No attendance records yet.</td></tr>`;
        return;
    }
    for (const a of data) {
        const date = toEasternDateOnly(a.timestamp);
        const time = toEasternTimeOnly(a.timestamp);
        const statusClass = a.status === 'present' ? 'status-present' : (a.status === 'late' ? 'status-late' : 'status-absent');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${date}</td><td>${a.course_name || 'N/A'}</td><td>${a.student_name}</td><td><span class="kbd">${a.student_id}</span></td><td>${time}</td><td><span class="status ${statusClass}">${a.status}</span></td>`;
        tbody.appendChild(tr);
    }
}

function updateHistoryCourseFilter(courses) {
    const select = $('#historyCourseFilter');
    select.innerHTML = '<option value="">All Courses</option>';
    for (const c of courses) {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
    }
}

$('#historySearch').oninput = filterAttendanceHistory;
$('#historyCourseFilter').onchange = filterAttendanceHistory;

function filterAttendanceHistory() {
    const query = $('#historySearch').value.toLowerCase();
    const courseId = $('#historyCourseFilter').value;

    let filtered = allAttendance;
    if (query) filtered = filtered.filter(a => a.student_name.toLowerCase().includes(query));
    if (courseId) filtered = filtered.filter(a => a.course_id == courseId);

    renderAttendanceHistory(filtered);
}

$('#btnExportCSV').onclick = () => {
    const data = allAttendance;
    if (!data.length) {
        showNotification('Error', 'No data to export', 'error');
        return;
    }

    const csv = [
        ['Date', 'Course', 'Student Name', 'Student ID', 'Time (ET)', 'Status'],
        ...data.map(a => [
            toEasternDateOnly(a.timestamp),
            a.course_name || 'N/A',
            a.student_name,
            a.student_id,
            toEasternTimeOnly(a.timestamp),
            a.status.toUpperCase()
        ])
    ].map(row => row.join(',')).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Success', 'CSV exported successfully', 'success');
};
// Add this function after the refreshAttendanceHistory section

async function deleteCourse(courseId, courseName) {
    const confirmed = await showConfirmDialog(
        'Delete Course?',
        `‚ö†Ô∏è WARNING: This will permanently delete "${courseName}" and all related data including: all attendance sessions, all attendance records, all student enrollments. This action cannot be undone. Are you sure you want to proceed?`
    );
    
    if (!confirmed) return;

    try {
        const result = await api(`/courses/${courseId}`, 'DELETE');
        showNotification('Success', result.message, 'success');
        await refreshAdminCourses();
        await refreshAttendanceHistory();
        
        // Clear any active session if it was for this course
        if (activeCourseId === courseId) {
            stopModalCamera();
            show('#checkinModal', false);
            activeSessionId = null;
            activeCourseId = null;
            stopLiveAttendancePolling();
        }
    } catch (e) {
        showNotification('Error', e.message || 'Failed to delete course', 'error');
    }
}

/* =========================
   STUDENT
   ========================= */
async function loadStudent() {
    show('#studentDash', true);

    try {
        const userInfo = await api('/user/info', 'GET');
        $('#studentNameDisplay').textContent = userInfo.name;
        $('#studentIdDisplay').textContent = userInfo.student_id;
        $('#studentEmailDisplay').textContent = userInfo.email;
        
        // Show edit button if student hasn't edited yet
        if (userInfo.can_edit_student_id) {
            show('#btnEditStudentId', true);
            $('#editIdMessage').textContent = '‚úèÔ∏è You can edit your Student ID once if it\'s incorrect';
            $('#editIdMessage').classList.remove('hidden');
        } else {
            show('#btnEditStudentId', false);
            $('#editIdMessage').textContent = 'üîí Student ID cannot be changed (already edited once)';
            $('#editIdMessage').classList.remove('hidden');
        }
    } catch (e) {
        console.error('Failed to load student info:', e);
    }

    refreshStudentCourses();
    refreshStudentAttendanceHistory();
    updateRecentAttendance();
}

// Student ID Edit Handlers
$('#btnEditStudentId').onclick = () => {
    show('#editStudentIdModal', true);
    $('#newStudentIdInput').value = '';
    $('#editIdError').textContent = '';
};

$('#btnCloseEditModal').onclick = () => {
    show('#editStudentIdModal', false);
};

$('#btnCancelEdit').onclick = () => {
    show('#editStudentIdModal', false);
};

$('#btnConfirmEdit').onclick = async () => {
    const newId = $('#newStudentIdInput').value.trim();
    
    // Validate
    if (!newId) {
        $('#editIdError').textContent = 'Please enter a Student ID';
        return;
    }
    if (!/^\d{8}$/.test(newId)) {
        $('#editIdError').textContent = 'Student ID must be exactly 8 digits';
        return;
    }
    
    try {
        const result = await api('/user/student-id', 'PUT', { new_student_id: newId });
        
        // Update display
        $('#studentIdDisplay').textContent = result.student_id;
        show('#btnEditStudentId', false);
        $('#editIdMessage').textContent = 'üîí Student ID cannot be changed (already edited once)';
        
        show('#editStudentIdModal', false);
        showNotification('Success', 'Student ID updated successfully! You cannot edit it again.', 'success');
        
        // Update stored student ID
        studentId = result.student_id;
    } catch (e) {
        $('#editIdError').textContent = e.message || 'Failed to update Student ID';
        showNotification('Error', e.message || 'Failed to update Student ID', 'error');
    }
};

// Validation: Only allow digits in student ID inputs
$('#studentIdInput').oninput = (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 8);
};

$('#newStudentIdInput').oninput = (e) => {
    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 8);
};

async function refreshStudentCourses() {
    try {
        const courses = await api('/courses/enrolled', 'GET');
        studentCourses = courses;
        updateStudentHistoryCourseFilter(courses);
        renderStudentCourses(courses);
    } catch (e) {
        $('#studentCourseRows').innerHTML = `<tr><td colspan="2" class="small">${e.message || 'Failed to load courses'}</td></tr>`;
    }
}

function renderStudentCourses(courses) {
    const tbody = $('#studentCourseRows');
    tbody.innerHTML = '';
    if (!courses.length) {
        tbody.innerHTML = `<tr><td colspan="2" class="small">Not enrolled in any courses yet.</td></tr>`;
        return;
    }
    for (const c of courses) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name}</td><td><span class="kbd">${c.id}</span></td>`;
        tbody.appendChild(tr);
    }
}

$('#studentCourseSearch').oninput = (e) => {
    const query = e.target.value.toLowerCase();
    const filtered = studentCourses.filter(c => c.name.toLowerCase().includes(query));
    renderStudentCourses(filtered);
};

$('#btnEnroll').onclick = async () => {
    try {
        const r = await api('/courses/enroll', 'POST', {
            join_code: $('#joinCode').value.trim().toUpperCase()
        });
        $('#enrollMsg').textContent = `Enrolled in course #${r.course_id}`;
        $('#joinCode').value = '';
        await refreshStudentCourses();
        showNotification('Success', `Enrolled in course #${r.course_id}`, 'success');
    } catch (e) {
        $('#enrollMsg').textContent = e.message || 'Enroll failed';
        showNotification('Error', e.message || 'Enrollment failed', 'error');
    }
};

async function updateRecentAttendance() {
    try {
        const history = await api('/attendance/my-history', 'GET');
        const display = $('#recentAttendanceDisplay');

        if (!history.length) {
            display.innerHTML = '<p class="small">No recent attendance records</p>';
            return;
        }

        display.innerHTML = '';
        const recent = history.slice(0, 3);

        for (const record of recent) {
            const date = toEasternDateOnly(record.timestamp);
            const time = toEasternTimeOnly(record.timestamp);
            const statusClass = record.status === 'present' ? 'status-present' :
                (record.status === 'late' ? 'status-late' : 'status-absent');

            const entry = document.createElement('div');
            entry.className = 'attendance-entry';
            entry.innerHTML = `
                <span>${record.course_name}</span> - 
                <span>${date} ${time}</span> - 
                <span class="status ${statusClass}">${record.status}</span>
            `;
            display.appendChild(entry);
        }
    } catch (e) {
        console.error('Failed to update recent attendance:', e);
    }
}

async function refreshStudentAttendanceHistory() {
    try {
        const data = await api('/attendance/my-history', 'GET');
        studentAttendance = data;
        renderStudentAttendanceHistory(data);
    } catch (e) {
        $('#studentHistoryRows').innerHTML = `<tr><td colspan="4" class="small">${e.message || 'Failed to load history'}</td></tr>`;
    }
}

function renderStudentAttendanceHistory(data) {
    const tbody = $('#studentHistoryRows');
    tbody.innerHTML = '';
    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="small">No attendance records yet.</td></tr>`;
        return;
    }
    for (const a of data) {
        const date = toEasternDateOnly(a.timestamp);
        const time = toEasternTimeOnly(a.timestamp);
        const statusClass = a.status === 'present' ? 'status-present' : (a.status === 'late' ? 'status-late' : 'status-absent');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${date}</td><td>${a.course_name || 'N/A'}</td><td>${time}</td><td><span class="status ${statusClass}">${a.status}</span></td>`;
        tbody.appendChild(tr);
    }
}

function updateStudentHistoryCourseFilter(courses) {
    const select = $('#studentHistoryCourseFilter');
    select.innerHTML = '<option value="">All Courses</option>';
    for (const c of courses) {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        select.appendChild(opt);
    }
}

$('#studentHistoryCourseFilter').onchange = () => {
    const courseId = $('#studentHistoryCourseFilter').value;
    let filtered = studentAttendance;
    if (courseId) filtered = filtered.filter(a => a.course_id == courseId);
    renderStudentAttendanceHistory(filtered);
};

$('#btnExportStudentCSV').onclick = () => {
    const data = studentAttendance;
    if (!data.length) {
        showNotification('Error', 'No data to export', 'error');
        return;
    }

    const csv = [
        ['Date', 'Course', 'Time (ET)', 'Status'],
        ...data.map(a => [
            toEasternDateOnly(a.timestamp),
            a.course_name || 'N/A',
            toEasternTimeOnly(a.timestamp),
            a.status.toUpperCase()
        ])
    ].map(row => row.join(',')).join('\n');

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `my_attendance_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    showNotification('Success', 'CSV exported successfully', 'success');
};

// Roster toggle
const rosterToggle = document.getElementById('rosterToggle');
const rosterSection = document.getElementById('rosterSection');
if (rosterToggle) {
    rosterToggle.addEventListener('click', () => {
        rosterSection.classList.toggle('section-collapsed');
        rosterToggle.classList.toggle('expanded');
    });
}

/* =========================
   INIT
   ========================= */
initTheme();
const token = localStorage.getItem('token');
if (token) {
    (async () => {
        try {
            const userInfo = await api('/user/info', 'GET');
            role = userInfo.role;
            username = userInfo.name;
            studentId = userInfo.student_id;
            $('#authTag').textContent = `Welcome, ${username}`;
            show('#authTag', true);
            show('#btnLogout', true);
            show('#landing', false);
            if (role === 'professor') loadAdmin();
            else loadStudent();
        } catch (e) {
            localStorage.removeItem('token');
        }
    })();
}

// Page load animation
window.addEventListener("load", () => {
    document.body.classList.add("loaded");
});

// Header scroll effect
window.addEventListener("scroll", () => {
    const header = document.querySelector("header");
    if (window.scrollY > 20) {
        header.classList.add("scrolled");
    } else {
        header.classList.remove("scrolled");
    }
});

// ============= MODERATOR PANEL & TAB SYSTEM =============

let isSuperAdmin = false;

// Setup dashboard tab switching
function setupDashboardTabs() {
    const adminDash = $('#adminDash');
    const moderatorDash = $('#moderatorDash');
    const dashboardTabsWrapper = $('#dashboardTabsWrapper');
    const tabAdminView = $('#tabAdminView');
    const tabModeratorView = $('#tabModeratorView');
    
    // Show tabs wrapper
    show('#dashboardTabsWrapper', true);
    
    // Tab click handlers
    tabAdminView.onclick = () => {
        // Switch tabs
        tabAdminView.classList.add('active');
        tabModeratorView.classList.remove('active');
        
        // Show/hide content
        show('#adminDash', true);
        show('#moderatorDash', false);
    };
    
    tabModeratorView.onclick = () => {
        // Switch tabs
        tabModeratorView.classList.add('active');
        tabAdminView.classList.remove('active');
        
        // Show/hide content
        show('#adminDash', false);
        show('#moderatorDash', true);
        
        // Refresh moderator data
        loadModeratorPanel();
    };
}

async function checkSuperAdminAccess() {
    try {
        const info = await api('/user/info', 'GET');
        isSuperAdmin = info.is_super_admin || false;
        
        if (info.role === 'professor') {
            // Setup tab system for all professors
            setupDashboardTabs();
            
            if (isSuperAdmin) {
                // Show the super admin tab
                show('#tabModeratorView', true);
                
                // Load moderator data
                loadModeratorPanel();
            }
        }
    } catch (e) {
        console.log('Not super admin or error checking:', e);
    }
}

async function loadModeratorPanel() {
    await Promise.all([
        loadModStats(),
        loadModUsers(),
        loadModCourses(),
        loadModAttendance()
    ]);
}

async function loadModStats() {
    try {
        const stats = await api('/moderator/stats', 'GET');
        $('#statTotalUsers').textContent = stats.total_users;
        $('#statStudents').textContent = stats.total_students;
        $('#statProfessors').textContent = stats.total_professors;
        $('#statCourses').textContent = stats.total_courses;
        $('#statSessions').textContent = stats.total_sessions;
        $('#statAttendance').textContent = stats.total_attendance_records;
    } catch (e) {
        console.error('Failed to load stats:', e);
    }
}

async function loadModUsers() {
    try {
        const users = await api('/moderator/users', 'GET');
        const tbody = $('#modUserRows');
        tbody.innerHTML = '';
        
        users.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td><span class="badge">${user.role}</span></td>
                <td>${user.student_id || '-'}</td>
                <td>
                    ${user.role === 'student' ? 
                        `<button class="btn-sm" onclick="promoteToProf(${user.id})">Make Prof</button>` : 
                        ''
                    }
                    <button class="btn-danger btn-sm" onclick="deleteUser(${user.id}, '${user.name.replace(/'/g, "\\'")}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        setupSearch('#modUserSearch', '#modUserRows');
    } catch (e) {
        console.error('Failed to load users:', e);
    }
}

async function loadModCourses() {
    try {
        const courses = await api('/moderator/courses', 'GET');
        const tbody = $('#modCourseRows');
        tbody.innerHTML = '';
        
        courses.forEach(course => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${course.name}</strong></td>
                <td><code>${course.code}</code></td>
                <td>${course.professor_name}<br><small>${course.professor_email}</small></td>
                <td>${course.student_count} students</td>
                <td>
                    <button class="btn-danger btn-sm" onclick="deleteCourse(${course.id}, '${course.name.replace(/'/g, "\\'")}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        setupSearch('#modCourseSearch', '#modCourseRows');
    } catch (e) {
        console.error('Failed to load courses:', e);
    }
}

async function loadModAttendance() {
    try {
        const records = await api('/moderator/attendance/all', 'GET');
        const tbody = $('#modAttendanceRows');
        tbody.innerHTML = '';
        
        records.forEach(r => {
            const tr = document.createElement('tr');
            const time = new Date(r.timestamp).toLocaleString();
            tr.innerHTML = `
                <td>${r.student_name}<br><small>${r.student_id}</small></td>
                <td>${r.course_name}</td>
                <td>${r.professor_name}</td>
                <td>${time}</td>
                <td><span class="badge">${r.status}</span></td>
            `;
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error('Failed to load attendance:', e);
    }
}

async function deleteUser(userId, userName) {
    if (!confirm(`Are you sure you want to DELETE ${userName}? This cannot be undone!`)) {
        return;
    }
    
    try {
        await api(`/moderator/user/${userId}`, 'DELETE');
        showNotification('Success', `${userName} deleted`, 'success');
        loadModeratorPanel();
    } catch (e) {
        showNotification('Error', e.message, 'error');
    }
}

async function deleteCourse(courseId, courseName) {
    if (!confirm(`Delete ${courseName}? This will remove all sessions and attendance data!`)) {
        return;
    }
    
    try {
        await api(`/moderator/course/${courseId}`, 'DELETE');
        showNotification('Success', `${courseName} deleted`, 'success');
        loadModeratorPanel();
    } catch (e) {
        showNotification('Error', e.message, 'error');
    }
}

async function promoteToProf(userId) {
    if (!confirm('Promote this student to professor? This will clear their student data.')) {
        return;
    }
    
    try {
        await api(`/moderator/make-professor/${userId}`, 'POST');
        showNotification('Success', 'User promoted to professor', 'success');
        loadModeratorPanel();
    } catch (e) {
        showNotification('Error', e.message, 'error');
    }
}

const cleanupBtn = document.getElementById('btnCleanup');
if (cleanupBtn) {
    cleanupBtn.onclick = async () => {
        const confirm1 = prompt('Type "DELETE" to confirm cleanup (this will delete all attendance and sessions):');
        if (confirm1 !== 'DELETE') return;
        
        try {
            const result = await api('/moderator/cleanup', 'POST');
            showNotification('Success', result.message, 'success');
            loadModeratorPanel();
        } catch (e) {
            showNotification('Error', e.message, 'error');
        }
    };
}

// Helper: Setup table search
function setupSearch(searchId, tableBodyId) {
    const searchInput = document.querySelector(searchId);
    const tableBody = document.querySelector(tableBodyId);
    
    if (!searchInput || !tableBody) return;
    
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    });
}
    </script>
</body>
</html>
